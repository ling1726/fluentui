import { Meta, Source, Link } from '@storybook/addon-docs';
import imageFile from '../../public/style-resolution.png';

<Meta title="Concepts/Developer/Build time styles" />

## Optimize runtime cost of styles

Fluent UI uses the open source [Griffel.js](https://griffel.js.org/) CSS-in-JS styling engine.
Make sure to take a look at the following docs to get started with styling in Fluent UI:

- [Quick start](?path=/docs/concepts-developer-quick-start--page)
- [Styling components](?path=/story/concepts-developer-styling-components--page)

While there is nothing wrong with the associated runtime costs of a CSS-in-JS engine, larger and more complex
applications might want to optimize for performance. In Fluent UI, the expensive runtime work only
happens on the first render of the component. This one-time work can be further optimized at build time by
pre-computing and transforming styles. You can refer to the [last section](#what-is-being-optimized) of this page for more details
about what the build time optimization does.

## Setup build time style transforms

- For application developers please use the [Webpack loader](#webpack)
- For library developers please use the [Babel preset](#babel)

### Webpack

```sh
yarn add @griffel/webpack-loader
```

In your Webpack config, simply add the `@griffel/webpack-loader` to the list of rules.

```javascript
// webpack.config.js
module: {
  rules: [
    {
      test: /\.(ts|tsx)$/,
      exclude: /node_modules/,
      use: {
        loader: '@griffel/webpack-loader',
      },
    },
    {
      test: /\.(ts|tsx)$/,
      exclude: /node_modules/,
      use: {
        loader: 'babel-loader',
        options: {
          babelOptions: {
            presets: ['@babel/preset-typescript'],
          },
        },
        // loader: 'ts-loader',
      },
    },
  ];
}
```

**We recommend adding the Griffel webpack loader after babel-loader or ts-loader.**. The underlying babel transforms
used by the webpack loader are configured by default to use the most basic language features. Therefore to avoid
extra configuration or parsing errors, using the webpack loader after transpilation is the recommended approach.

#### Typescript (and additional transpilation) support

The Webpack loader evaluate styles at runtime using [Linaria](https://github.com/callstack/linaria). For typescript
it's necessary to install `@babel/preset-typescript` and configure it in the `babelOptions` of the loader. Similarly
any other language features that might be required can also be configured here. While the order of loaders will
ensure that the webpack loader will run on transpiled code (for a specific module), runtime evaluation can potentially require other
modules that are not transpiled. Any additional language features can also be configured in the same way.

### Babel

The Babel preset is used internally by the Webpack loader. For applications the Webpack loader is appropriate
since it is the most popular bundler.
However, library developers might prefer to use the Babel preset since it is a better fit for tools such as [Rollup](https://rollupjs.org/guide/en/).

```sh
yarn add @griffel/babel-preset
```

Simply create a Babel configuration file such as `.babelrc` and add the preset.

```json
{
  "presets": [
    [
      "@griffel",
      {
        "babelOptions": {
          "presets": ["@babel/preset-typescript"]
        }
      }
    ]
  ]
}
```

#### Typescript (and additional transpilation) support

The Babel preset will evaluate stlyes at runtime using [Linaria](https://github.com/callstack/linaria). For typescript
it's necessary to install `@babel/preset-typescript` and configure it in the preset. Similarly
any other language features that might be required can also be configured here. While the order of loaders will
ensure that the webpack loader will run on transpiled code (for a specific module), runtime evaluation can potentially require other
modules that are not transpiled. Any additional language features can also be configured in the same way.

#### Importing from a third party package

If Griffel is re-exported from a third party package, it's necessary to configure the preset to use a different
module source. By default, the preset already handles imports from `@fluentui/react-components`.

```js
import { makeStyles } from 'custom-package';
```

```json
{
  "presets": [
    [
      "@griffel/babel",
      {
        "modules": [{ "moduleSource": "custom-package", "importName": "makeStyles" }]
      }
    ]
  ]
}
```

### What is being optimized

> ⚠️ Style resolution only needs to happen on the initial render of a component. Therefore, without build time
> optimization, the performance after the initial render is comparable. It is perfectly reasonable to follow the
> quickstart guide and introduce build time optimization if/when it is required.

Let's start with a simple example:

```tsx
import { makeStyles } from '@fluentui/react-components';

const useStyles = makeStyles({
  root: { paddingLeft: '1px', display: 'flex' },
});

function Component() {
  const classes = useStyles();

  return <div className={classes.root} />;
}
```

A correct invocation of `makeStyles` creates a styling hook that can be used inside a component. When the `useStyles`
hook is invoked inside a component the styles are resolved and applied to the document. You can look at the image below
which describes what work is done during style resolution. **Note that this work only happens once, during first render**.

<img src={imageFile} alt={'Illustration of work done by style resolution'} />

The final result before the CSS rules are inserted into DOM can be prepared during build time through
the methods above. Once the styles of our simple example are transformed at build time the resulting bundle contains
a result similar to what is in our diagram. The actual runtime code of `makeStyles` is completely stripped from the
bundle and replaced with a lightweight function that simply concatenates the CSS classes and inserts them to
DOM.

```tsx
const useStyles = __styles(
  {
    root: {
      mc9l5x: 'f22iagw',
      uwmqm3: ['f10xn8zz', 'f136y8j8'],
    },
  },
  {
    d: [
      '.f22iagw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}',
      '.f10xn8zz{padding-left:1px;}',
      '.f136y8j8{padding-right:1px;}',
    ],
  },
);

function Component() {
  const classes = useStyles();
  return <div className={classes.root} />;
}
```
